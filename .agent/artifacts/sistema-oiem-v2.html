<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n OIEM - Abastible 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #0047AB;
            --primary-dark: #003380;
            --primary-light: #e6f0ff;
            --success: #10b981;
            --success-bg: #d1fae5;
            --danger: #ef4444;
            --danger-bg: #fee2e2;
            --warning: #f59e0b;
            --warning-bg: #fef3c7;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --radius: 12px;
            --radius-sm: 8px;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%); min-height: 100vh; color: var(--gray-800); }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Profile Selector */
        .profile-selector { display: flex; min-height: 100vh; align-items: center; justify-content: center; padding: 20px; }
        .profile-selector-container { text-align: center; max-width: 800px; }
        .profile-selector h1 { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 32px; color: var(--primary); margin-bottom: 8px; }
        .profile-selector > .profile-selector-container > p { color: var(--gray-600); margin-bottom: 40px; }
        .profile-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; }
        .profile-card { background: white; border-radius: var(--radius); padding: 40px 30px; box-shadow: var(--shadow-md); cursor: pointer; transition: all 0.3s; border: 3px solid transparent; }
        .profile-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .profile-card.principal:hover { border-color: var(--primary); }
        .profile-card.contratista:hover { border-color: var(--success); }
        .profile-card-icon { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 36px; }
        .profile-card.principal .profile-card-icon { background: var(--primary-light); }
        .profile-card.contratista .profile-card-icon { background: var(--success-bg); }
        .profile-card h2 { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 20px; margin-bottom: 8px; }
        .profile-card.principal h2 { color: var(--primary); }
        .profile-card.contratista h2 { color: var(--success); }
        .profile-card p { font-size: 14px; color: var(--gray-500); }
        
        /* App Container */
        .app-container { display: none; }
        .app-container.active { display: block; }
        
        /* Header */
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 24px 30px; border-radius: var(--radius); margin-bottom: 24px; box-shadow: var(--shadow-lg); }
        .header.contratista-header { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .header-left h1 { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .header-left p { opacity: 0.9; font-size: 14px; }
        .header-badge { background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px; font-size: 12px; }
        .btn-back { background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: var(--radius-sm); cursor: pointer; font-family: inherit; font-size: 14px; }
        .btn-back:hover { background: rgba(255,255,255,0.3); }
        
        /* Cards */
        .card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; overflow: hidden; }
        .card-header { background: var(--gray-50); padding: 16px 24px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
        .card-header h2 { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 16px; font-weight: 600; }
        .card-body { padding: 24px; }
        
        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-size: 13px; font-weight: 500; color: var(--gray-600); }
        .form-group input, .form-group select, .form-group textarea { padding: 10px 14px; border: 1px solid var(--gray-300); border-radius: var(--radius-sm); font-size: 14px; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .form-group textarea { min-height: 80px; resize: vertical; }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border: none; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500; font-family: inherit; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: white; border: 1px solid var(--gray-300); color: var(--gray-700); }
        .btn-outline:hover { background: var(--gray-50); }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-xs { padding: 4px 8px; font-size: 12px; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--gray-200); font-size: 14px; }
        th { background: var(--gray-50); font-weight: 600; color: var(--gray-600); font-size: 13px; }
        tr:hover td { background: var(--gray-50); }
        
        /* Tabs */
        .tabs { display: flex; gap: 4px; background: var(--gray-100); padding: 4px; border-radius: var(--radius-sm); margin-bottom: 20px; overflow-x: auto; }
        .tab { flex: 1; min-width: max-content; padding: 10px 16px; border: none; background: transparent; border-radius: 6px; font-size: 14px; font-weight: 500; color: var(--gray-600); cursor: pointer; font-family: inherit; }
        .tab.active { background: white; color: var(--primary); box-shadow: var(--shadow); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Elementos */
        .elemento { margin-bottom: 16px; border: 1px solid var(--gray-200); border-radius: var(--radius-sm); overflow: hidden; }
        .elemento-header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 12px 20px; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .elemento-badge { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px; font-size: 12px; }
        .elemento-content { background: white; }
        
        /* Activity */
        .activity { display: grid; grid-template-columns: 50px 1fr 120px 80px 100px 100px; gap: 10px; padding: 12px 16px; border-bottom: 1px solid var(--gray-100); align-items: center; font-size: 13px; }
        .activity:last-child { border-bottom: none; }
        .activity:hover { background: var(--gray-50); }
        .activity-code { font-weight: 600; color: var(--primary); background: var(--primary-light); padding: 4px 8px; border-radius: 6px; text-align: center; font-size: 11px; }
        .activity-desc { color: var(--gray-700); line-height: 1.4; }
        .activity-toggle { display: flex; gap: 4px; }
        .toggle-btn { width: 40px; height: 30px; border: 2px solid var(--gray-300); border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; background: white; }
        .toggle-btn.active-1 { background: var(--success); border-color: var(--success); color: white; }
        .toggle-btn.active-0 { background: var(--danger); border-color: var(--danger); color: white; }
        
        /* Badges */
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; background: var(--gray-100); }
        .badge-success { background: var(--success-bg); color: var(--success); }
        .badge-warning { background: var(--warning-bg); color: var(--warning); }
        .badge-danger { background: var(--danger-bg); color: var(--danger); }
        .badge-info { background: var(--primary-light); color: var(--primary); }
        
        /* Progress */
        .progress-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .progress-card { background: white; border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); }
        .progress-card h3 { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-500); margin-bottom: 8px; }
        .progress-value { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 28px; font-weight: 700; }
        .progress-bar-container { margin-top: 10px; background: var(--gray-200); height: 6px; border-radius: 3px; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 3px; transition: width 0.5s; }
        
        /* Actions Bar */
        .actions-bar { display: flex; justify-content: space-between; padding: 16px 24px; background: var(--gray-50); border-top: 1px solid var(--gray-200); flex-wrap: wrap; gap: 12px; }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: var(--radius); max-width: 700px; width: 100%; max-height: 90vh; overflow: auto; box-shadow: var(--shadow-lg); }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; }
        .modal-header h2 { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-400); }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 12px; }
        
        /* Toast */
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--gray-800); color: white; padding: 14px 24px; border-radius: var(--radius-sm); box-shadow: var(--shadow-lg); font-size: 14px; z-index: 1000; opacity: 0; transform: translateY(20px); transition: all 0.3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background: var(--success); }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 48px 24px; color: var(--gray-500); }
        .empty-state h3 { color: var(--gray-700); margin-bottom: 8px; }
        
        /* File Input */
        .file-input-wrapper { position: relative; display: inline-block; }
        .file-input-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .activity { grid-template-columns: 1fr; gap: 8px; }
        }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .profile-cards { grid-template-columns: 1fr; }
        }
        @media print {
            .btn, .tabs, .actions-bar, .btn-back, .profile-selector { display: none !important; }
            body { background: white; }
        }
    </style>
</head>
<body>
    <!-- SELECTOR DE PERFIL -->
    <div class="profile-selector" id="profile-selector">
        <div class="profile-selector-container">
            <h1>üìä Sistema de Gesti√≥n OIEM</h1>
            <p>Programa de Gesti√≥n OIEM Contratistas Distribuci√≥n Granel 2025 - Abastible</p>
            <div class="profile-cards">
                <div class="profile-card principal" onclick="selectProfile('principal')">
                    <div class="profile-card-icon">üè¢</div>
                    <h2>Empresa Principal</h2>
                    <p>Gesti√≥n de actividades, frecuencias, revisi√≥n de evidencias y dashboard</p>
                </div>
                <div class="profile-card contratista" onclick="selectProfile('contratista')">
                    <div class="profile-card-icon">üèóÔ∏è</div>
                    <h2>Contratista EECC</h2>
                    <p>Registro de cumplimiento mensual, carga de evidencias y seguimiento</p>
                </div>
            </div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div class="app-container" id="app-principal">
        <div class="container">
            <header class="header">
                <div class="header-content">
                    <div class="header-left">
                        <h1>üè¢ Panel Empresa Principal</h1>
                        <p>Gesti√≥n de Programa OIEM - Abastible 2025</p>
                    </div>
                    <div class="btn-group">
                        <span class="header-badge">Meta: 85%</span>
                        <button class="btn-back" onclick="goBack()">‚Üê Cambiar Perfil</button>
                    </div>
                </div>
            </header>
            <div class="tabs">
                <button class="tab active" onclick="showTabPrincipal('dashboard')">üìä Dashboard</button>
                <button class="tab" onclick="showTabPrincipal('actividades')">‚öôÔ∏è Gesti√≥n Actividades</button>
                <button class="tab" onclick="showTabPrincipal('evidencias')">üìé Evidencias</button>
            </div>
            <div id="tab-principal-dashboard" class="tab-content active">
                <div class="progress-section" id="principal-stats"></div>
                <div class="card">
                    <div class="card-header">
                        <h2>üìã Registros de Contratistas</h2>
                        <button class="btn btn-outline btn-sm" onclick="exportarExcel()">üìä Exportar Excel</button>
                    </div>
                    <div class="card-body" id="tabla-registros-principal"></div>
                </div>
            </div>
            <div id="tab-principal-actividades" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>‚öôÔ∏è Configuraci√≥n de Actividades</h2>
                        <button class="btn btn-primary btn-sm" onclick="abrirModalElemento()">‚ûï Nuevo Elemento</button>
                    </div>
                    <div class="card-body" id="lista-elementos-config"></div>
                </div>
            </div>
            <div id="tab-principal-evidencias" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>üìé Evidencias Recibidas</h2>
                    </div>
                    <div class="card-body" id="tabla-evidencias-principal"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- APP CONTRATISTA -->
    <div class="app-container" id="app-contratista">
        <div class="container">
            <header class="header contratista-header">
                <div class="header-content">
                    <div class="header-left">
                        <h1>üèóÔ∏è Panel Contratista EECC</h1>
                        <p>Registro de Cumplimiento OIEM 2025</p>
                    </div>
                    <div class="btn-group">
                        <span class="header-badge">üìÖ Env√≠o: 5to d√≠a h√°bil</span>
                        <button class="btn-back" onclick="goBack()">‚Üê Cambiar Perfil</button>
                    </div>
                </div>
            </header>
            <div class="tabs">
                <button class="tab active" onclick="showTabContratista('registro')">üìù Registro Mensual</button>
                <button class="tab" onclick="showTabContratista('historial')">üìã Mi Historial</button>
                <button class="tab" onclick="showTabContratista('evidencias')">üìé Mis Evidencias</button>
            </div>
            <div id="tab-contratista-registro" class="tab-content active">
                <div class="card">
                    <div class="card-header"><h2>üè¢ Informaci√≥n del Contratista</h2></div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nombre EECC *</label>
                                <input type="text" id="c-nombre-eecc" placeholder="Nombre de la empresa">
                            </div>
                            <div class="form-group">
                                <label>Dependencia *</label>
                                <input type="text" id="c-dependencia" placeholder="Ej: Planta Maip√∫">
                            </div>
                            <div class="form-group">
                                <label>Mes *</label>
                                <select id="c-mes">
                                    <option value="">Seleccione</option>
                                    <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
                                    <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
                                    <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option>
                                    <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>A√±o *</label>
                                <select id="c-anio"><option value="2025">2025</option><option value="2026">2026</option></select>
                            </div>
                            <div class="form-group">
                                <label>Personas nuevas</label>
                                <input type="number" id="c-personas-nuevas" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>Supervisores</label>
                                <input type="number" id="c-supervisores" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>Prevencionistas</label>
                                <input type="number" id="c-prevencionistas" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>Dotaci√≥n Total</label>
                                <input type="number" id="c-dotacion" value="0" min="0">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2>‚úÖ Actividades del Programa</h2>
                        <span id="c-total-progress" style="font-weight: 600; color: var(--primary);">0%</span>
                    </div>
                    <div class="card-body" style="padding: 0;" id="c-lista-actividades"></div>
                    <div class="actions-bar">
                        <button class="btn btn-outline" onclick="limpiarFormContratista()">üóëÔ∏è Limpiar</button>
                        <button class="btn btn-success" onclick="guardarRegistro()">üíæ Guardar Registro</button>
                    </div>
                </div>
            </div>
            <div id="tab-contratista-historial" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>üìã Mi Historial</h2>
                        <button class="btn btn-outline btn-sm" onclick="exportarExcel()">üìä Exportar</button>
                    </div>
                    <div class="card-body" id="c-historial-container"></div>
                </div>
            </div>
            <div id="tab-contratista-evidencias" class="tab-content">
                <div class="card">
                    <div class="card-header"><h2>üìé Mis Evidencias</h2></div>
                    <div class="card-body" id="c-evidencias-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div class="modal-overlay" id="modal-actividad">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-actividad-titulo">Actividad</h2>
                <button class="modal-close" onclick="cerrarModal('modal-actividad')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-actividad-id">
                <input type="hidden" id="edit-elemento-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>C√≥digo</label>
                        <input type="text" id="edit-actividad-codigo" placeholder="Ej: 1.1">
                    </div>
                    <div class="form-group">
                        <label>Frecuencia</label>
                        <select id="edit-actividad-frecuencia">
                            <option value="Mensual">Mensual</option>
                            <option value="Trimestral">Trimestral</option>
                            <option value="Semestral">Semestral</option>
                            <option value="Anual">Anual</option>
                            <option value="Cuando aplique">Cuando aplique</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Descripci√≥n</label>
                        <textarea id="edit-actividad-descripcion" rows="2"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label>Criterios de cumplimiento</label>
                        <textarea id="edit-actividad-criterios" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modal-actividad')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarActividad()">üíæ Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-elemento">
        <div class="modal">
            <div class="modal-header">
                <h2>Nuevo Elemento</h2>
                <button class="modal-close" onclick="cerrarModal('modal-elemento')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label>N√∫mero</label>
                        <input type="text" id="nuevo-elemento-numero" placeholder="Ej: 13">
                    </div>
                    <div class="form-group full-width">
                        <label>Nombre</label>
                        <input type="text" id="nuevo-elemento-nombre" placeholder="Ej: Gesti√≥n de Cambios">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modal-elemento')">Cancelar</button>
                <button class="btn btn-primary" onclick="crearElemento()">‚ûï Crear</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-evidencia">
        <div class="modal">
            <div class="modal-header">
                <h2>Evidencia</h2>
                <button class="modal-close" onclick="cerrarModal('modal-evidencia')">&times;</button>
            </div>
            <div class="modal-body" id="modal-evidencia-content"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-plantilla">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üìÑ Plantilla de Evidencia</h2>
                <button class="modal-close" onclick="cerrarModal('modal-plantilla')">&times;</button>
            </div>
            <div class="modal-body" id="modal-plantilla-content"></div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modal-plantilla')">Cerrar</button>
                <button class="btn btn-primary" onclick="imprimirPlantilla()">üñ®Ô∏è Imprimir</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ==================== DATOS ====================
        const MESES = ['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        
        const ELEMENTOS_DEFAULT = [
            { id:'e1', numero:'1', nombre:'Liderazgo y compromiso', actividades:[
                {id:'1.1',codigo:'1.1',descripcion:'Ejecuci√≥n del Programa SAFEALIGN',criterios:'2 CS, 2 SST, 2 IRF por jefatura',frecuencia:'Mensual'},
                {id:'1.2',codigo:'1.2',descripcion:'Participaci√≥n en CPHS de faena',criterios:'Registro de asistencia con acta',frecuencia:'Mensual'},
                {id:'1.3',codigo:'1.3',descripcion:'Reuni√≥n de accountability',criterios:'Presentaci√≥n bajo formato establecido',frecuencia:'Mensual'}
            ]},
            { id:'e2', numero:'2', nombre:'Evaluaci√≥n y Gesti√≥n del riesgo', actividades:[
                {id:'2.1',codigo:'2.1',descripcion:'An√°lisis de riesgos (AST) de tarea cr√≠tica',criterios:'AST documentado de matriz de riesgos',frecuencia:'Mensual'},
                {id:'2.2',codigo:'2.2',descripcion:'Cumplimiento protocolos MINSAL',criterios:'100% cumplimiento protocolos',frecuencia:'Mensual'}
            ]},
            { id:'e5', numero:'5', nombre:'Competencias y capacitaci√≥n', actividades:[
                {id:'3.1',codigo:'3.1',descripcion:'Inducciones D.S. N¬∞44 (Charla ODI)',criterios:'100% personal nuevo con inducci√≥n',frecuencia:'Mensual'},
                {id:'3.2',codigo:'3.2',descripcion:'Plan de capacitaci√≥n anual',criterios:'Avance seg√∫n cronograma',frecuencia:'Mensual'}
            ]},
            { id:'e67', numero:'6-7', nombre:'Operaciones e Integridad Mec√°nica', actividades:[
                {id:'4.1',codigo:'4.1',descripcion:'Check List cami√≥n granel',criterios:'100% check list correctos',frecuencia:'Mensual'},
                {id:'4.2',codigo:'4.2',descripcion:'Cierre de tarjetas',criterios:'Tarjetas cerradas en plazo',frecuencia:'Mensual'}
            ]},
            { id:'e9', numero:'9', nombre:'Servicios de terceros', actividades:[
                {id:'5.1',codigo:'5.1',descripcion:'Acreditaci√≥n 100% EECC y trabajadores',criterios:'100% personal acreditado',frecuencia:'Mensual'},
                {id:'5.2',codigo:'5.2',descripcion:'Verificaci√≥n laboral',criterios:'100% obligaciones pagadas',frecuencia:'Mensual'},
                {id:'5.3',codigo:'5.3',descripcion:'Reuni√≥n accountability con resumen',criterios:'Resumen y evidencia presentados',frecuencia:'Mensual'}
            ]},
            { id:'e10', numero:'10', nombre:'Investigaci√≥n de accidentes', actividades:[
                {id:'6.1',codigo:'6.1',descripcion:'Informe investigaci√≥n en plazo',criterios:'Informe enviado en plazo',frecuencia:'Cuando aplique'},
                {id:'6.2',codigo:'6.2',descripcion:'Cierre acciones correctivas',criterios:'Acciones cerradas',frecuencia:'Mensual'}
            ]},
            { id:'e12', numero:'12', nombre:'Evaluaci√≥n y Mejora', actividades:[
                {id:'7.1',codigo:'7.1',descripcion:'Incidentes no registrables',criterios:'Registro actualizado',frecuencia:'Mensual'},
                {id:'7.2',codigo:'7.2',descripcion:'Incidentes registrables',criterios:'Registro actualizado',frecuencia:'Mensual'}
            ]}
        ];

        let actividadesContratista = {};

        // ==================== INIT ====================
        function initApp() {
            if (!localStorage.getItem('oiem_elementos')) localStorage.setItem('oiem_elementos', JSON.stringify(ELEMENTOS_DEFAULT));
            if (!localStorage.getItem('oiem_registros')) localStorage.setItem('oiem_registros', JSON.stringify([]));
            if (!localStorage.getItem('oiem_evidencias')) localStorage.setItem('oiem_evidencias', JSON.stringify([]));
        }

        // ==================== NAVEGACI√ìN ====================
        function selectProfile(profile) {
            document.getElementById('profile-selector').style.display = 'none';
            document.getElementById('app-' + profile).classList.add('active');
            if (profile === 'principal') { renderDashboard(); renderActividadesConfig(); }
            else { renderActividadesContratista(); }
        }

        function goBack() {
            document.querySelectorAll('.app-container').forEach(a => a.classList.remove('active'));
            document.getElementById('profile-selector').style.display = 'flex';
        }

        function showTabPrincipal(tabId) {
            document.querySelectorAll('#app-principal .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#app-principal .tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-principal-' + tabId).classList.add('active');
            event.target.classList.add('active');
            if (tabId === 'dashboard') renderDashboard();
            if (tabId === 'actividades') renderActividadesConfig();
            if (tabId === 'evidencias') renderEvidenciasPrincipal();
        }

        function showTabContratista(tabId) {
            document.querySelectorAll('#app-contratista .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#app-contratista .tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-contratista-' + tabId).classList.add('active');
            event.target.classList.add('active');
            if (tabId === 'historial') renderHistorial();
            if (tabId === 'evidencias') renderEvidenciasContratista();
        }

        // ==================== PRINCIPAL - DASHBOARD ====================
        function renderDashboard() {
            const registros = JSON.parse(localStorage.getItem('oiem_registros') || '[]');
            const elementos = JSON.parse(localStorage.getItem('oiem_elementos') || '[]');
            const totalAct = elementos.reduce((s,e) => s + e.actividades.length, 0);
            const eeccs = [...new Set(registros.map(r => r.nombreEECC))];
            
            let cumplimiento = 0;
            if (registros.length > 0) {
                const totalPos = totalAct * registros.length;
                let totalCump = 0;
                registros.forEach(r => { totalCump += Object.values(r.actividades||{}).filter(v=>v===1).length; });
                cumplimiento = totalPos > 0 ? Math.round((totalCump/totalPos)*100) : 0;
            }
            
            const cls = cumplimiento >= 85 ? 'success' : cumplimiento >= 60 ? 'warning' : 'danger';
            document.getElementById('principal-stats').innerHTML = `
                <div class="progress-card">
                    <h3>Cumplimiento General</h3>
                    <div class="progress-value" style="color:var(--${cls})">${cumplimiento}%</div>
                    <div class="progress-bar-container"><div class="progress-bar" style="width:${cumplimiento}%;background:var(--${cls})"></div></div>
                </div>
                <div class="progress-card"><h3>Contratistas</h3><div class="progress-value">${eeccs.length}</div></div>
                <div class="progress-card"><h3>Registros</h3><div class="progress-value">${registros.length}</div></div>
                <div class="progress-card"><h3>Meta</h3><div class="progress-value" style="color:var(--${cumplimiento>=85?'success':'danger'})">${cumplimiento>=85?'‚úÖ':'‚ùå'} 85%</div></div>
            `;
            
            if (registros.length === 0) {
                document.getElementById('tabla-registros-principal').innerHTML = '<div class="empty-state"><h3>Sin registros</h3></div>';
                return;
            }
            
            let html = '<table><thead><tr><th>Periodo</th><th>EECC</th><th>Dependencia</th><th>Cumplimiento</th><th>Evidencias</th></tr></thead><tbody>';
            registros.sort((a,b) => b.periodo.localeCompare(a.periodo)).forEach(r => {
                const pct = calcPct(r.actividades, elementos);
                const pcls = pct >= 85 ? 'success' : pct >= 60 ? 'warning' : 'danger';
                const evs = JSON.parse(localStorage.getItem('oiem_evidencias')||'[]').filter(e=>e.registroId===r.id).length;
                html += `<tr><td><strong>${MESES[r.mes]} ${r.anio}</strong></td><td>${r.nombreEECC}</td><td>${r.dependencia}</td><td><span class="badge badge-${pcls}">${pct}%</span></td><td><span class="badge badge-info">${evs}</span></td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('tabla-registros-principal').innerHTML = html;
        }

        // ==================== PRINCIPAL - CONFIG ACTIVIDADES ====================
        function renderActividadesConfig() {
            const elementos = JSON.parse(localStorage.getItem('oiem_elementos') || '[]');
            let html = '';
            elementos.forEach(elem => {
                html += `<div class="elemento">
                    <div class="elemento-header" onclick="toggleElem(this)">
                        <span>ELEMENTO ${elem.numero}: ${elem.nombre}</span>
                        <div class="btn-group">
                            <button class="btn btn-xs" style="background:rgba(255,255,255,0.2);color:white;border:none" onclick="event.stopPropagation();agregarActividad('${elem.id}')">‚ûï</button>
                            <button class="btn btn-xs" style="background:rgba(239,68,68,0.8);color:white;border:none" onclick="event.stopPropagation();eliminarElemento('${elem.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="elemento-content"><table><thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Criterios</th><th>Frecuencia</th><th>Acciones</th></tr></thead><tbody>`;
                elem.actividades.forEach(a => {
                    html += `<tr><td><span class="badge badge-info">${a.codigo}</span></td><td>${a.descripcion}</td><td style="font-size:12px;color:var(--gray-500)">${a.criterios||'-'}</td><td>${a.frecuencia}</td><td><div class="btn-group"><button class="btn btn-outline btn-xs" onclick="editarActividad('${elem.id}','${a.id}')">‚úèÔ∏è</button><button class="btn btn-danger btn-xs" onclick="eliminarActividad('${elem.id}','${a.id}')">üóëÔ∏è</button></div></td></tr>`;
                });
                if (elem.actividades.length === 0) html += '<tr><td colspan="5" style="text-align:center;color:var(--gray-400)">Sin actividades</td></tr>';
                html += '</tbody></table></div></div>';
            });
            document.getElementById('lista-elementos-config').innerHTML = html || '<div class="empty-state"><h3>Sin elementos</h3></div>';
        }

        function abrirModalElemento() {
            document.getElementById('nuevo-elemento-numero').value = '';
            document.getElementById('nuevo-elemento-nombre').value = '';
            document.getElementById('modal-elemento').classList.add('show');
        }

        function crearElemento() {
            const num = document.getElementById('nuevo-elemento-numero').value.trim();
            const nom = document.getElementById('nuevo-elemento-nombre').value.trim();
            if (!num || !nom) { showToast('Complete todos los campos'); return; }
            const elementos = JSON.parse(localStorage.getItem('oiem_elementos')||'[]');
            elementos.push({ id: 'e'+Date.now(), numero: num, nombre: nom, actividades: [] });
            localStorage.setItem('oiem_elementos', JSON.stringify(elementos));
            cerrarModal('modal-elemento');
            renderActividadesConfig();
            showToast('‚úÖ Elemento creado', 'success');
        }

        function eliminarElemento(id) {
            if (!confirm('¬øEliminar elemento y sus actividades?')) return;
            let elems = JSON.parse(localStorage.getItem('oiem_elementos')||'[]');
            elems = elems.filter(e => e.id !== id);
            localStorage.setItem('oiem_elementos', JSON.stringify(elems));
            renderActividadesConfig();
            showToast('üóëÔ∏è Eliminado');
        }

        function agregarActividad(elemId) {
            document.getElementById('modal-actividad-titulo').textContent = 'Nueva Actividad';
            document.getElementById('edit-actividad-id').value = '';
            document.getElementById('edit-elemento-id').value = elemId;
            document.getElementById('edit-actividad-codigo').value = '';
            document.getElementById('edit-actividad-descripcion').value = '';
            document.getElementById('edit-actividad-criterios').value = '';
            document.getElementById('edit-actividad-frecuencia').value = 'Mensual';
            document.getElementById('modal-actividad').classList.add('show');
        }

        function editarActividad(elemId, actId) {
            const elems = JSON.parse(localStorage.getItem('oiem_elementos')||'[]');
            const elem = elems.find(e => e.id === elemId);
            const act = elem?.actividades.find(a => a.id === actId);
            if (!act) return;
            document.getElementById('modal-actividad-titulo').textContent = 'Editar Actividad';
            document.getElementById('edit-actividad-id').value = actId;
            document.getElementById('edit-elemento-id').value = elemId;
            document.getElementById('edit-actividad-codigo').value = act.codigo;
            document.getElementById('edit-actividad-descripcion').value = act.descripcion;
            document.getElementById('edit-actividad-criterios').value = act.criterios || '';
            document.getElementById('edit-actividad-frecuencia').value = act.frecuencia;
            document.getElementById('modal-actividad').classList.add('show');
        }

        function guardarActividad() {
            const elemId = document.getElementById('edit-elemento-id').value;
            const actId = document.getElementById('edit-actividad-id').value;
            const codigo = document.getElementById('edit-actividad-codigo').value.trim();
            const desc = document.getElementById('edit-actividad-descripcion').value.trim();
            const crit = document.getElementById('edit-actividad-criterios').value.trim();
            const frec = document.getElementById('edit-actividad-frecuencia').value;
            if (!codigo || !desc) { showToast('Complete c√≥digo y descripci√≥n'); return; }
            const elems = JSON.parse(localStorage.getItem('oiem_elementos')||'[]');
            const elem = elems.find(e => e.id === elemId);
            if (!elem) return;
            if (actId) {
                const act = elem.actividades.find(a => a.id === actId);
                if (act) { act.codigo = codigo; act.descripcion = desc; act.criterios = crit; act.frecuencia = frec; }
            } else {
                elem.actividades.push({ id: codigo, codigo, descripcion: desc, criterios: crit, frecuencia: frec });
            }
            localStorage.setItem('oiem_elementos', JSON.stringify(elems));
            cerrarModal('modal-actividad');
            renderActividadesConfig();
            showToast('‚úÖ Guardado', 'success');
        }

        function eliminarActividad(elemId, actId) {
            if (!confirm('¬øEliminar actividad?')) return;
            const elems = JSON.parse(localStorage.getItem('oiem_elementos')||'[]');
            const elem = elems.find(e => e.id === elemId);
            if (elem) { elem.actividades = elem.actividades.filter(a => a.id !== actId); }
            localStorage.setItem('oiem_elementos', JSON.stringify(elems));
            renderActividadesConfig();
            showToast('üóëÔ∏è Eliminado');
        }

        // ==================== PRINCIPAL - EVIDENCIAS ====================
        function renderEvidenciasPrincipal() {
            const evs = JSON.parse(localStorage.getItem('oiem_evidencias')||'[]');
            if (evs.length === 0) {
                document.getElementById('tabla-evidencias-principal').innerHTML = '<div class="empty-state"><h3>Sin evidencias</h3></div>';
                return;
            }
            let html = '<table><thead><tr><th>Fecha</th><th>EECC</th><th>Actividad</th><th>Archivo</th><th>Acciones</th></tr></thead><tbody>';
            evs.forEach(e => {
                html += `<tr><td>${new Date(e.fecha).toLocaleDateString('es-CL')}</td><td>${e.nombreEECC}</td><td><span class="badge badge-info">${e.actividadCodigo}</span></td><td>${e.nombreArchivo}</td><td><button class="btn btn-outline btn-xs" onclick="verEvidencia('${e.id}')">üëÅÔ∏è</button> <button class="btn btn-primary btn-xs" onclick="descargarEvidencia('${e.id}')">‚¨áÔ∏è</button></td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('tabla-evidencias-principal').innerHTML = html;
        }

        // ==================== CONTRATISTA - REGISTRO ====================
        function renderActividadesContratista() {
            const elementos = JSON.parse(localStorage.getItem('oiem_elementos')||'[]');
            let html = '';
            elementos.forEach(elem => {
                html += `<div class="elemento">
                    <div class="elemento-header" onclick="toggleElem(this)">
                        <span>ELEMENTO ${elem.numero}: ${elem.nombre}</span>
                        <span class="elemento-badge" id="badge-${elem.id}">0/${elem.actividades.length}</span>
                    </div>
                    <div class="elemento-content">`;
                elem.actividades.forEach(a => {
                    html += `<div class="activity" data-activity="${a.id}">
                        <span class="activity-code">${a.codigo}</span>
                        <div class="activity-desc"><div>${a.descripcion}</div><small style="color:var(--gray-500)">${a.criterios||''}</small></div>
                        <input type="text" placeholder="Responsable" class="resp-input" data-act="${a.id}" style="padding:6px 8px;font-size:12px;border:1px solid var(--gray-300);border-radius:4px">
                        <span style="font-size:11px">${a.frecuencia}</span>
                        <div class="activity-toggle">
                            <button class="toggle-btn" onclick="setAct('${a.id}',1,this)">1</button>
                            <button class="toggle-btn" onclick="setAct('${a.id}',0,this)">0</button>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-outline btn-xs" onclick="descargarPlantilla('${a.id}','${a.codigo}','${encodeURIComponent(a.descripcion)}','${encodeURIComponent(a.criterios||'')}')">üìÑ</button>
                            <div class="file-input-wrapper">
                                <button class="btn btn-outline btn-xs" id="btn-up-${a.id}">üì§</button>
                                <input type="file" accept="image/*,.pdf" onchange="subirEvidencia('${a.id}',this)">
                            </div>
                        </div>
                    </div>`;
                });
                html += '</div></div>';
            });
            document.getElementById('c-lista-actividades').innerHTML = html;
            actualizarBadges();
        }

        function setAct(actId, val, btn) {
            actividadesContratista[actId] = val;
            btn.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active-1','active-0'));
            btn.classList.add(val === 1 ? 'active-1' : 'active-0');
            actualizarBadges();
            actualizarProgreso();
        }

        function actualizarBadges() {
            const elementos = JSON.parse(localStorage.getItem('oiem_elementos')||'[]');
            elementos.forEach(e => {
                const cump = e.actividades.filter(a => actividadesContratista[a.id] === 1).length;
                const badge = document.getElementById('badge-' + e.id);
                if (badge) badge.textContent = `${cump}/${e.actividades.length}`;
            });
        }

        function actualizarProgreso() {
            const elementos = JSON.parse(localStorage.getItem('oiem_elementos')||'[]');
            const total = elementos.reduce((s,e) => s + e.actividades.length, 0);
            const cump = Object.values(actividadesContratista).filter(v => v === 1).length;
            const pct = total > 0 ? Math.round((cump/total)*100) : 0;
            const el = document.getElementById('c-total-progress');
            el.textContent = pct + '%';
            el.style.color = pct >= 85 ? 'var(--success)' : pct >= 60 ? 'var(--warning)' : 'var(--danger)';
        }

        function guardarRegistro() {
            const nombre = document.getElementById('c-nombre-eecc').value.trim();
            const dep = document.getElementById('c-dependencia').value.trim();
            const mes = document.getElementById('c-mes').value;
            const anio = document.getElementById('c-anio').value;
            if (!nombre || !dep || !mes) { showToast('Complete campos obligatorios (*)'); return; }
            
            const responsables = {};
            document.querySelectorAll('.resp-input').forEach(i => { responsables[i.dataset.act] = i.value.trim(); });
            
            const reg = {
                id: Date.now(),
                fecha: new Date().toISOString(),
                periodo: `${anio}-${mes.padStart(2,'0')}`,
                nombreEECC: nombre,
                dependencia: dep,
                mes: parseInt(mes),
                anio: parseInt(anio),
                personasNuevas: parseInt(document.getElementById('c-personas-nuevas').value)||0,
                supervisores: parseInt(document.getElementById('c-supervisores').value)||0,
                prevencionistas: parseInt(document.getElementById('c-prevencionistas').value)||0,
                dotacion: parseInt(document.getElementById('c-dotacion').value)||0,
                actividades: {...actividadesContratista},
                responsables
            };
            
            let regs = JSON.parse(localStorage.getItem('oiem_registros')||'[]');
            const idx = regs.findIndex(r => r.periodo === reg.periodo && r.nombreEECC === reg.nombreEECC);
            if (idx >= 0) {
                if (confirm('Ya existe registro para este periodo. ¬øReemplazar?')) { reg.id = regs[idx].id; regs[idx] = reg; }
                else return;
            } else { regs.push(reg); }
            
            localStorage.setItem('oiem_registros', JSON.stringify(regs));
            showToast('‚úÖ Guardado', 'success');
        }

        function limpiarFormContratista() {
            if (!confirm('¬øLimpiar formulario?')) return;
            document.getElementById('c-nombre-eecc').value = '';
            document.getElementById('c-dependencia').value = '';
            document.getElementById('c-mes').value = '';
            document.getElementById('c-personas-nuevas').value = '0';
            document.getElementById('c-supervisores').value = '0';
            document.getElementById('c-prevencionistas').value = '0';
            document.getElementById('c-dotacion').value = '0';
            actividadesContratista = {};
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active-1','active-0'));
            document.querySelectorAll('.resp-input').forEach(i => i.value = '');
            actualizarBadges();
            actualizarProgreso();
        }

        // ==================== CONTRATISTA - HISTORIAL ====================
        function renderHistorial() {
            const regs = JSON.parse(localStorage.getItem('oiem_registros')||'[]');
            const elementos = JSON.parse(localStorage.getItem('oiem_elementos')||'[]');
            if (regs.length === 0) {
                document.getElementById('c-historial-container').innerHTML = '<div class="empty-state"><h3>Sin registros</h3></div>';
                return;
            }
            let html = '<table><thead><tr><th>Periodo</th><th>EECC</th><th>Cumplimiento</th><th>Acciones</th></tr></thead><tbody>';
            regs.sort((a,b) => b.periodo.localeCompare(a.periodo)).forEach(r => {
                const pct = calcPct(r.actividades, elementos);
                const cls = pct >= 85 ? 'success' : pct >= 60 ? 'warning' : 'danger';
                html += `<tr><td><strong>${MESES[r.mes]} ${r.anio}</strong></td><td>${r.nombreEECC}</td><td><span class="badge badge-${cls}">${pct}%</span></td><td><button class="btn btn-outline btn-xs" onclick="cargarRegistro(${r.id})">‚úèÔ∏è</button> <button class="btn btn-danger btn-xs" onclick="eliminarRegistro(${r.id})">üóëÔ∏è</button></td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('c-historial-container').innerHTML = html;
        }

        function cargarRegistro(id) {
            const regs = JSON.parse(localStorage.getItem('oiem_registros')||'[]');
            const r = regs.find(x => x.id === id);
            if (!r) return;
            document.getElementById('c-nombre-eecc').value = r.nombreEECC;
            document.getElementById('c-dependencia').value = r.dependencia;
            document.getElementById('c-mes').value = r.mes;
            document.getElementById('c-anio').value = r.anio;
            document.getElementById('c-personas-nuevas').value = r.personasNuevas||0;
            document.getElementById('c-supervisores').value = r.supervisores||0;
            document.getElementById('c-prevencionistas').value = r.prevencionistas||0;
            document.getElementById('c-dotacion').value = r.dotacion||0;
            actividadesContratista = {...r.actividades};
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active-1','active-0'));
            for (const [actId, val] of Object.entries(actividadesContratista)) {
                const act = document.querySelector(`[data-activity="${actId}"]`);
                if (act) { const btns = act.querySelectorAll('.toggle-btn'); if (btns.length>=2) btns[val===1?0:1].classList.add(val===1?'active-1':'active-0'); }
            }
            if (r.responsables) { for (const [actId,resp] of Object.entries(r.responsables)) { const inp = document.querySelector(`.resp-input[data-act="${actId}"]`); if(inp) inp.value = resp; } }
            actualizarBadges();
            actualizarProgreso();
            showTabContratista('registro');
            showToast('üìù Cargado para edici√≥n');
        }

        function eliminarRegistro(id) {
            if (!confirm('¬øEliminar registro?')) return;
            let regs = JSON.parse(localStorage.getItem('oiem_registros')||'[]');
            regs = regs.filter(r => r.id !== id);
            localStorage.setItem('oiem_registros', JSON.stringify(regs));
            let evs = JSON.parse(localStorage.getItem('oiem_evidencias')||'[]');
            evs = evs.filter(e => e.registroId !== id);
            localStorage.setItem('oiem_evidencias', JSON.stringify(evs));
            renderHistorial();
            showToast('üóëÔ∏è Eliminado');
        }

        // ==================== EVIDENCIAS ====================
        function descargarPlantilla(actId, codigo, descEnc, critEnc) {
            const desc = decodeURIComponent(descEnc);
            const crit = decodeURIComponent(critEnc);
            const nombre = document.getElementById('c-nombre-eecc').value || '[EECC]';
            const dep = document.getElementById('c-dependencia').value || '[DEPENDENCIA]';
            const mes = document.getElementById('c-mes').value;
            const anio = document.getElementById('c-anio').value;
            const periodo = mes ? `${MESES[parseInt(mes)]} ${anio}` : '[PERIODO]';
            
            const html = `<div id="plantilla-print" style="font-family:Arial;padding:30px;max-width:700px;margin:0 auto">
                <h1 style="text-align:center;color:#0047AB;border-bottom:3px solid #0047AB;padding-bottom:10px">üìã EVIDENCIA DE CUMPLIMIENTO</h1>
                <h3 style="text-align:center;color:#666;margin-bottom:30px">Programa OIEM - Abastible 2025</h3>
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #ddd"><span><strong>EECC:</strong></span><span>${nombre}</span></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #ddd"><span><strong>Dependencia:</strong></span><span>${dep}</span></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #ddd"><span><strong>Periodo:</strong></span><span>${periodo}</span></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #ddd"><span><strong>Fecha:</strong></span><span>${new Date().toLocaleDateString('es-CL')}</span></div>
                <hr style="margin:20px 0">
                <div style="background:#f5f5f5;padding:20px;border-radius:8px;margin-bottom:20px">
                    <h3 style="color:#0047AB;margin-bottom:10px">Actividad ${codigo}</h3>
                    <p style="font-size:15px;margin-bottom:10px">${desc}</p>
                    <p style="font-size:13px;color:#666"><strong>Criterios:</strong> ${crit||'N/A'}</p>
                </div>
                <div style="margin-bottom:25px"><h4>Observaciones:</h4><div style="border:1px solid #ccc;min-height:80px;padding:10px;border-radius:4px"></div></div>
                <div style="margin-bottom:25px"><h4>Detalle de cumplimiento:</h4><div style="border:1px solid #ccc;min-height:60px;padding:10px;border-radius:4px"></div></div>
                <div style="display:flex;justify-content:space-between;margin-top:50px">
                    <div style="width:45%;text-align:center"><div style="height:50px"></div><div style="border-top:2px solid #333;padding-top:8px"><strong>Responsable EECC</strong><br><small>Nombre y firma</small></div></div>
                    <div style="width:45%;text-align:center"><div style="height:50px"></div><div style="border-top:2px solid #333;padding-top:8px"><strong>Supervisor</strong><br><small>Nombre y firma</small></div></div>
                </div>
                <p style="margin-top:40px;text-align:center;color:#999;font-size:11px">Sistema de Gesti√≥n OIEM - Abastible</p>
            </div>`;
            document.getElementById('modal-plantilla-content').innerHTML = html;
            document.getElementById('modal-plantilla').classList.add('show');
        }

        function imprimirPlantilla() {
            const cont = document.getElementById('plantilla-print').innerHTML;
            const win = window.open('','_blank');
            win.document.write('<html><head><title>Plantilla OIEM</title></head><body>'+cont+'</body></html>');
            win.document.close();
            win.print();
        }

        function subirEvidencia(actId, input) {
            const file = input.files[0];
            if (!file) return;
            const nombre = document.getElementById('c-nombre-eecc').value;
            const mes = document.getElementById('c-mes').value;
            const anio = document.getElementById('c-anio').value;
            if (!nombre || !mes) { showToast('Complete primero datos del contratista'); input.value=''; return; }
            
            const regs = JSON.parse(localStorage.getItem('oiem_registros')||'[]');
            let reg = regs.find(r => r.periodo === `${anio}-${mes.padStart(2,'0')}` && r.nombreEECC === nombre);
            const regId = reg ? reg.id : Date.now();
            
            const elems = JSON.parse(localStorage.getItem('oiem_elementos')||'[]');
            let actInfo = {codigo:actId, descripcion:''};
            elems.forEach(e => { const a = e.actividades.find(x=>x.id===actId); if(a) actInfo=a; });
            
            const reader = new FileReader();
            reader.onload = function(e) {
                let evs = JSON.parse(localStorage.getItem('oiem_evidencias')||'[]');
                const idx = evs.findIndex(ev => ev.registroId===regId && ev.actividadId===actId);
                const nueva = { id:Date.now().toString(), registroId:regId, nombreEECC:nombre, periodo:`${anio}-${mes.padStart(2,'0')}`, actividadId:actId, actividadCodigo:actInfo.codigo, actividadDesc:actInfo.descripcion, nombreArchivo:file.name, tipo:file.type, data:e.target.result, fecha:new Date().toISOString() };
                if (idx >= 0) evs[idx] = nueva; else evs.push(nueva);
                localStorage.setItem('oiem_evidencias', JSON.stringify(evs));
                const btn = document.getElementById('btn-up-'+actId);
                if (btn) { btn.textContent='‚úÖ'; btn.style.background='var(--success-bg)'; btn.style.color='var(--success)'; }
                showToast('‚úÖ Evidencia subida', 'success');
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function renderEvidenciasContratista() {
            const evs = JSON.parse(localStorage.getItem('oiem_evidencias')||'[]');
            if (evs.length === 0) {
                document.getElementById('c-evidencias-container').innerHTML = '<div class="empty-state"><h3>Sin evidencias</h3><p>Suba evidencias con el bot√≥n üì§</p></div>';
                return;
            }
            let html = '<table><thead><tr><th>Fecha</th><th>Periodo</th><th>Actividad</th><th>Archivo</th><th>Acciones</th></tr></thead><tbody>';
            evs.forEach(e => {
                html += `<tr><td>${new Date(e.fecha).toLocaleDateString('es-CL')}</td><td>${e.periodo}</td><td><span class="badge badge-info">${e.actividadCodigo}</span></td><td>${e.nombreArchivo}</td><td><button class="btn btn-outline btn-xs" onclick="verEvidencia('${e.id}')">üëÅÔ∏è</button> <button class="btn btn-danger btn-xs" onclick="eliminarEvidencia('${e.id}')">üóëÔ∏è</button></td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('c-evidencias-container').innerHTML = html;
        }

        function verEvidencia(id) {
            const evs = JSON.parse(localStorage.getItem('oiem_evidencias')||'[]');
            const ev = evs.find(e => e.id === id);
            if (!ev) return;
            let cont = '';
            if (ev.tipo.startsWith('image/')) cont = `<img src="${ev.data}" style="max-width:100%;border-radius:8px">`;
            else if (ev.tipo === 'application/pdf') cont = `<iframe src="${ev.data}" style="width:100%;height:400px;border:none"></iframe>`;
            else cont = `<a href="${ev.data}" download="${ev.nombreArchivo}" class="btn btn-primary">‚¨áÔ∏è Descargar</a>`;
            document.getElementById('modal-evidencia-content').innerHTML = `<p><strong>EECC:</strong> ${ev.nombreEECC}</p><p><strong>Actividad:</strong> ${ev.actividadCodigo}</p><p><strong>Fecha:</strong> ${new Date(ev.fecha).toLocaleString('es-CL')}</p><hr style="margin:15px 0">${cont}`;
            document.getElementById('modal-evidencia').classList.add('show');
        }

        function descargarEvidencia(id) {
            const evs = JSON.parse(localStorage.getItem('oiem_evidencias')||'[]');
            const ev = evs.find(e => e.id === id);
            if (!ev) return;
            const link = document.createElement('a');
            link.href = ev.data;
            link.download = ev.nombreArchivo;
            link.click();
        }

        function eliminarEvidencia(id) {
            if (!confirm('¬øEliminar evidencia?')) return;
            let evs = JSON.parse(localStorage.getItem('oiem_evidencias')||'[]');
            evs = evs.filter(e => e.id !== id);
            localStorage.setItem('oiem_evidencias', JSON.stringify(evs));
            renderEvidenciasContratista();
            showToast('üóëÔ∏è Eliminada');
        }

        // ==================== EXPORTAR ====================
        function exportarExcel() {
            const regs = JSON.parse(localStorage.getItem('oiem_registros')||'[]');
            const elems = JSON.parse(localStorage.getItem('oiem_elementos')||'[]');
            if (regs.length === 0) { showToast('Sin datos'); return; }
            
            const data = [];
            const headers = ['Periodo','EECC','Dependencia','Dotaci√≥n'];
            elems.forEach(e => e.actividades.forEach(a => headers.push(a.codigo)));
            headers.push('% Cumplimiento');
            data.push(headers);
            
            regs.forEach(r => {
                const row = [`${MESES[r.mes]} ${r.anio}`, r.nombreEECC, r.dependencia, r.dotacion||0];
                elems.forEach(e => e.actividades.forEach(a => { const v = r.actividades?.[a.id]; row.push(v===1?1:v===0?0:''); }));
                row.push(calcPct(r.actividades,elems)+'%');
                data.push(row);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'OIEM');
            XLSX.writeFile(wb, `OIEM_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('üìä Exportado', 'success');
        }

        // ==================== UTILIDADES ====================
        function calcPct(acts, elementos) {
            if (!acts) return 0;
            const total = elementos.reduce((s,e) => s + e.actividades.length, 0);
            const cump = Object.values(acts).filter(v => v === 1).length;
            return total > 0 ? Math.round((cump/total)*100) : 0;
        }

        function toggleElem(header) {
            const content = header.nextElementSibling;
            if (content) content.style.display = content.style.display === 'none' ? 'block' : 'none';
        }

        function cerrarModal(id) { document.getElementById(id).classList.remove('show'); }

        function showToast(msg, type='info') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (type==='success'?' success':'');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // Cerrar modales
        document.addEventListener('keydown', e => { if(e.key==='Escape') document.querySelectorAll('.modal-overlay.show').forEach(m=>m.classList.remove('show')); });
        document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if(e.target.classList.contains('modal-overlay')) e.target.classList.remove('show'); }));

        // Init
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
